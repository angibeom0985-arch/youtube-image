<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 패널 - 유튜브 이미지 생성기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- CodeMirror 에디터 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/markdown/markdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
    
    <!-- CodeMirror 테마 및 애드온 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/material-darker.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closetag.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/xml-fold.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.css">
    
    <style>
        .CodeMirror {
            height: 500px;
            font-size: 14px;
            line-height: 1.5;
        }
        .preview-container {
            height: 500px;
            overflow-y: auto;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background: white;
            padding: 1rem;
        }
        .editor-toolbar {
            background: #f8f9fa;
            padding: 0.5rem;
            border-bottom: 1px solid #e9ecef;
            border-radius: 0.5rem 0.5rem 0 0;
        }
        .toolbar-btn {
            margin-right: 0.5rem;
            padding: 0.25rem 0.5rem;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .toolbar-btn:hover {
            background: #495057;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- 인증 확인 -->
    <script>
        if (!sessionStorage.getItem('adminAuth')) {
            window.location.href = '/admin.html';
        }
    </script>

    <div class="container mx-auto px-4 py-8">
        <!-- 헤더 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">🛠️ 관리자 패널</h1>
                    <p class="text-gray-600 mt-1">유튜브 이미지 생성기 콘텐츠 관리</p>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600">
                        👋 <span id="adminUser"></span>님 환영합니다
                    </span>
                    <button onclick="logout()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">
                        🚪 로그아웃
                    </button>
                </div>
            </div>
        </div>

        <!-- 대시보드 -->
        <div class="grid md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-3 bg-blue-100 rounded-full">
                        <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-lg font-semibold text-gray-800">가이드 문서</h3>
                        <p class="text-gray-600">API 키 및 사용법 가이드</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-3 bg-green-100 rounded-full">
                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-lg font-semibold text-gray-800">이미지 관리</h3>
                        <p class="text-gray-600">스크린샷 및 가이드 이미지</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-3 bg-purple-100 rounded-full">
                        <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-lg font-semibold text-gray-800">설정 관리</h3>
                        <p class="text-gray-600">사이트 설정 및 배포</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 파일 편집 섹션 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-2xl font-semibold mb-6">📝 문서 편집</h2>
            
            <!-- 파일 선택 -->
            <div class="grid md:grid-cols-2 gap-4 mb-6">
                <div>
                    <h3 class="font-medium mb-3">편집할 문서 선택</h3>
                    <div class="space-y-2">
                        <button onclick="loadFile('api-key-guide.html')" 
                                class="w-full text-left p-3 border rounded hover:bg-blue-50 transition-colors">
                            📋 API 키 발급 가이드
                        </button>
                        <button onclick="loadFile('user-guide.html')" 
                                class="w-full text-left p-3 border rounded hover:bg-blue-50 transition-colors">
                            📖 사용법 가이드
                        </button>
                        <button onclick="loadFile('index.html')" 
                                class="w-full text-left p-3 border rounded hover:bg-blue-50 transition-colors">
                            🏠 메인 페이지
                        </button>
                    </div>
                </div>
                
                <div>
                    <h3 class="font-medium mb-3">현재 편집 중인 파일</h3>
                    <div id="current-file" class="p-4 bg-gray-50 rounded border">
                        파일을 선택해주세요
                    </div>
                    
                    <!-- 빠른 액션 -->
                    <div class="mt-4 space-y-2">
                        <button onclick="addImage()" class="w-full px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-colors">
                            🖼️ 이미지 추가
                        </button>
                        <button onclick="addStep()" class="w-full px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                            📋 단계 추가
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 고급 텍스트 편집기 -->
            <div class="w-full">
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-semibold">✏️ 고급 텍스트 편집기</h3>
                        <div class="flex items-center space-x-2">
                            <!-- 글쓰기 모드 선택 -->
                            <div class="flex items-center space-x-2 mr-4">
                                <label class="text-sm font-medium">글쓰기 모드:</label>
                                <select id="writingMode" onchange="changeWritingMode()" class="px-2 py-1 border rounded text-sm bg-blue-50">
                                    <option value="basic">📝 기본모드</option>
                                    <option value="html">🌐 HTML모드</option>
                                </select>
                            </div>
                            
                            <select id="editorMode" onchange="changeEditorMode()" class="px-3 py-1 border rounded text-sm">
                                <option value="xml">HTML</option>
                                <option value="markdown">Markdown</option>
                                <option value="javascript">JavaScript</option>
                                <option value="css">CSS</option>
                            </select>
                            <button onclick="formatCode()" class="toolbar-btn">Format</button>
                            <button onclick="toggleWordWrap()" class="toolbar-btn" id="wrapBtn">Wrap</button>
                        </div>
                    </div>
                    
                    <!-- 편집기 툴바 -->
                    <div class="editor-toolbar">
                        <div id="basic-toolbar" style="display: block;">
                            <!-- 기본모드 툴바 -->
                            <button onclick="insertTemplate('heading')" class="toolbar-btn">H1</button>
                            <button onclick="insertTemplate('bold')" class="toolbar-btn"><b>B</b></button>
                            <button onclick="insertTemplate('italic')" class="toolbar-btn"><i>I</i></button>
                            <button onclick="insertTemplate('link')" class="toolbar-btn">🔗</button>
                            <button onclick="insertImageAtCursor()" class="toolbar-btn bg-green-600 hover:bg-green-700">📷 이미지</button>
                            <button onclick="insertTemplate('code')" class="toolbar-btn">&lt;/&gt;</button>
                            <button onclick="insertTemplate('list')" class="toolbar-btn">�</button>
                            <span class="border-l mx-2"></span>
                            <button onclick="undo()" class="toolbar-btn">↶</button>
                            <button onclick="redo()" class="toolbar-btn">↷</button>
                        </div>
                        
                        <div id="html-toolbar" style="display: none;">
                            <!-- HTML모드 툴바 -->
                            <button onclick="insertBasicTemplate('heading')" class="toolbar-btn"># 제목</button>
                            <button onclick="insertBasicTemplate('bold')" class="toolbar-btn"><b>굵게</b></button>
                            <button onclick="insertBasicTemplate('italic')" class="toolbar-btn"><i>기울임</i></button>
                            <button onclick="insertBasicTemplate('link')" class="toolbar-btn">🔗 링크</button>
                            <button onclick="insertImageAtCursor()" class="toolbar-btn bg-green-600 hover:bg-green-700">📷 이미지</button>
                            <button onclick="insertBasicTemplate('code')" class="toolbar-btn">코드</button>
                            <button onclick="insertBasicTemplate('list')" class="toolbar-btn">• 목록</button>
                            <span class="border-l mx-2"></span>
                            <button onclick="undo()" class="toolbar-btn">↶</button>
                            <button onclick="redo()" class="toolbar-btn">↷</button>
                        </div>
                    </div>
                    
                    <!-- CodeMirror 편집기가 여기에 삽입됩니다 -->
                    <div id="editor-container"></div>
                    
                    <!-- 파일 작업 -->
                    <div class="mt-4 p-4 bg-gray-50 rounded">
                        <h4 class="font-medium mb-2">� 파일 작업</h4>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="saveToLocal()" class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">
                                💾 로컬 저장
                            </button>
                            <button onclick="loadFromLocal()" class="px-3 py-1 bg-gray-500 text-white rounded text-sm hover:bg-gray-600">
                                📂 로컬 불러오기
                            </button>
                            <button onclick="exportFile()" class="px-3 py-1 bg-purple-500 text-white rounded text-sm hover:bg-purple-600">
                                📤 파일 내보내기
                            </button>
                            <button onclick="importFile()" class="px-3 py-1 bg-indigo-500 text-white rounded text-sm hover:bg-indigo-600">
                                📥 파일 가져오기
                            </button>
                        </div>
                                                </div>
                        <input type="file" id="import-file" accept=".html,.md,.txt" style="display:none" onchange="handleFileImport(event)">
                    </div>
                    
                    <!-- 새창 미리보기 -->
                    <div class="mt-4 p-4 bg-blue-50 rounded border">
                        <div class="flex justify-between items-center">
                            <div>
                                <h4 class="font-medium text-blue-800">🪟 미리보기</h4>
                                <p class="text-sm text-blue-600">새창에서 작성한 내용을 확인할 수 있습니다.</p>
                            </div>
                            <button onclick="openPreviewInNewWindow()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                                새창에서 미리보기
                            </button>
                        </div>
                    </div>
                    
                    <!-- 이미지 업로드 -->
                    <div class="mt-4 p-4 bg-gray-50 rounded">
                        <h4 class="font-medium mb-2">🖼️ 이미지 관리</h4>
                        <input type="file" id="image-upload" accept="image/*" multiple
                               class="w-full p-2 border rounded mb-2" onchange="handleImageUpload(event)">
                        <div id="image-preview" class="grid grid-cols-2 gap-2 mt-2"></div>
                    </div>
                </div>
            </div>
                    </div>
                </div>
                
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-semibold">👁️ 미리보기</h3>
                        <div class="flex items-center space-x-2">
                            <button onclick="openPreviewInNewWindow()" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                                🪟 새창에서 미리보기
                            </button>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-50 rounded border text-center text-gray-600">
                        <p>미리보기는 새창에서 확인하실 수 있습니다.</p>
                        <p class="text-sm mt-2">위의 "새창에서 미리보기" 버튼을 클릭하세요.</p>
                    </div>
                    
                    <!-- 이미지 업로드 -->
                    <div class="mt-4 p-4 bg-gray-50 rounded">
                        <h4 class="font-medium mb-2">�️ 이미지 관리</h4>
                        <input type="file" id="image-upload" accept="image/*" multiple
                               class="w-full p-2 border rounded mb-2" onchange="handleImageUpload(event)">
                        <div id="image-preview" class="grid grid-cols-2 gap-2 mt-2"></div>
                    </div>
                </div>
            </div>
            
            <!-- 저장 및 배포 버튼 -->
            <div class="flex gap-4 mt-6">
                <button onclick="updatePreview()" 
                        class="px-6 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                    🔄 미리보기 새로고침
                </button>
                <button onclick="saveFile()" 
                        class="px-6 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-colors">
                    💾 파일 저장
                </button>
                <button onclick="deployChanges()" 
                        class="px-6 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 transition-colors">
                    🚀 Git에 커밋 & 배포
                </button>
                <button onclick="viewSite()" 
                        class="px-6 py-2 bg-indigo-500 text-white rounded hover:bg-indigo-600 transition-colors">
                    🌐 사이트 보기
                </button>
            </div>
        </div>

        <!-- 로그 섹션 -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold mb-4">📜 작업 로그</h2>
            <div id="activity-log" class="bg-gray-50 p-4 rounded border max-h-60 overflow-y-auto">
                <p class="text-gray-600 text-sm">관리자 패널 로드 완료 - <span class="timestamp"></span></p>
            </div>
        </div>
    </div>

    <script>
        let currentFile = '';
        let fileContent = '';
        let codeMirrorEditor = null;
        let isPreviewMode = 'html'; // 'html' or 'markdown'
        let currentWritingMode = 'basic'; // 'basic' or 'html'
        
        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('adminUser').textContent = sessionStorage.getItem('adminUser') || 'Admin';
            document.querySelector('.timestamp').textContent = new Date().toLocaleString('ko-KR');
            
            // CodeMirror 에디터 초기화
            initializeEditor();
            
            // 기본모드로 초기화
            currentWritingMode = 'basic';
            document.getElementById('writingMode').value = 'basic';
            document.getElementById('basic-toolbar').style.display = 'block';
            document.getElementById('html-toolbar').style.display = 'none';
        });

        // CodeMirror 에디터 초기화
        function initializeEditor() {
            const editorContainer = document.getElementById('editor-container');
            
            codeMirrorEditor = CodeMirror(editorContainer, {
                mode: 'xml',
                theme: 'material-darker',
                lineNumbers: true,
                lineWrapping: false,
                matchBrackets: true,
                autoCloseTags: true,
                foldGutter: true,
                gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
                extraKeys: {
                    "Ctrl-S": function(cm) { saveFile(); },
                    "Ctrl-O": function(cm) { document.getElementById('import-file').click(); },
                    "Ctrl-/": function(cm) { toggleComment(); },
                    "F11": function(cm) { cm.setOption("fullScreen", !cm.getOption("fullScreen")); },
                    "Esc": function(cm) { if (cm.getOption("fullScreen")) cm.setOption("fullScreen", false); }
                },
                placeholder: "HTML, 마크다운 또는 텍스트 내용을 입력하세요...",
                value: "<!-- 편집할 파일을 선택하세요 -->"
            });

            // 실시간 미리보기 업데이트
            codeMirrorEditor.on('change', function() {
                clearTimeout(window.previewUpdateTimer);
                window.previewUpdateTimer = setTimeout(updatePreview, 500);
            });

            addLog('고급 편집기 초기화 완료');
        }

        // 편집기 모드 변경
        function changeEditorMode() {
            const mode = document.getElementById('editorMode').value;
            codeMirrorEditor.setOption('mode', mode);
            addLog(`편집기 모드 변경: ${mode}`);
        }

        // 글쓰기 모드 변경
        function changeWritingMode() {
            currentWritingMode = document.getElementById('writingMode').value;
            
            // 편집기 모드 자동 변경
            if (currentWritingMode === 'html') {
                document.getElementById('editorMode').value = 'xml';
                codeMirrorEditor.setOption('mode', 'xml');
                document.getElementById('basic-toolbar').style.display = 'none';
                document.getElementById('html-toolbar').style.display = 'block';
                addLog('🌐 HTML모드로 전환');
            } else {
                document.getElementById('editorMode').value = 'xml';
                codeMirrorEditor.setOption('mode', 'xml');
                document.getElementById('basic-toolbar').style.display = 'block';
                document.getElementById('html-toolbar').style.display = 'none';
                addLog('📝 기본모드로 전환');
            }
        }

        // 코드 포맷팅
        function formatCode() {
            const content = codeMirrorEditor.getValue();
            // 간단한 HTML 포맷팅 (실제로는 더 정교한 파서가 필요)
            let formatted = content
                .replace(/></g, '>\n<')
                .replace(/^\s+|\s+$/g, '')
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0)
                .join('\n');
            
            codeMirrorEditor.setValue(formatted);
            addLog('코드 포맷팅 완료');
        }

        // 워드 랩 토글
        function toggleWordWrap() {
            const currentWrap = codeMirrorEditor.getOption('lineWrapping');
            codeMirrorEditor.setOption('lineWrapping', !currentWrap);
            document.getElementById('wrapBtn').textContent = !currentWrap ? 'NoWrap' : 'Wrap';
            addLog(`워드 랩: ${!currentWrap ? '켬' : '끔'}`);
        }

        // 기본모드 템플릿 삽입
        function insertBasicTemplate(type) {
            const cursor = codeMirrorEditor.getCursor();
            let template = '';
            
            switch(type) {
                case 'heading':
                    template = '# 제목을 입력하세요';
                    break;
                case 'bold':
                    template = '**굵은 텍스트**';
                    break;
                case 'italic':
                    template = '*기울임 텍스트*';
                    break;
                case 'link':
                    const linkUrl = prompt('링크 URL을 입력하세요:', 'https://');
                    const linkText = prompt('링크 텍스트를 입력하세요:', '링크');
                    if (linkUrl && linkText) {
                        template = `[${linkText}](${linkUrl})`;
                    }
                    break;
                case 'code':
                    template = '`코드`';
                    break;
                case 'list':
                    template = '• 항목 1\n• 항목 2\n• 항목 3';
                    break;
            }
            
            if (template) {
                codeMirrorEditor.replaceRange(template, cursor);
                addLog(`기본모드 템플릿 삽입: ${type}`);
            }
        }

        // 새창에서 미리보기 열기
        function openPreviewInNewWindow() {
            const content = codeMirrorEditor.getValue();
            let htmlContent = '';
            
            if (currentWritingMode === 'basic') {
                // 기본모드: 간단한 마크다운 스타일 변환
                htmlContent = content
                    .replace(/^# (.+)$/gm, '<h1>$1</h1>')
                    .replace(/^\*\*(.+?)\*\*$/gm, '<strong>$1</strong>')
                    .replace(/^\*(.+?)\*$/gm, '<em>$1</em>')
                    .replace(/^• (.+)$/gm, '<li>$1</li>')
                    .replace(/`(.+?)`/g, '<code>$1</code>')
                    .replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2" target="_blank">$1</a>')
                    .replace(/\n/g, '<br>');
                
                // li 태그들을 ul로 감싸기
                htmlContent = htmlContent.replace(/(<li>.*<\/li>)/g, '<ul>$1</ul>');
            } else {
                // HTML모드: 그대로 사용
                htmlContent = content;
            }
            
            const previewWindow = window.open('', '_blank', 'width=800,height=600');
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ko">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>미리보기</title>
                    <style>
                        body { 
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                            line-height: 1.6;
                            max-width: 800px;
                            margin: 0 auto;
                            padding: 20px;
                            color: #333;
                        }
                        h1, h2, h3 { color: #2563eb; }
                        code { 
                            background: #f3f4f6;
                            padding: 2px 4px;
                            border-radius: 3px;
                            font-family: 'Monaco', monospace;
                        }
                        img { max-width: 100%; height: auto; }
                        ul { padding-left: 20px; }
                        li { margin: 5px 0; }
                    </style>
                </head>
                <body>
                    ${htmlContent}
                </body>
                </html>
            `);
            previewWindow.document.close();
            
            addLog('새창에서 미리보기 열기', 'success');
        }

        // 마크다운 템플릿 삽입
        function insertMarkdownTemplate(type) {
            const cursor = codeMirrorEditor.getCursor();
            let template = '';
            
            switch(type) {
                case 'heading':
                    template = '# 제목을 입력하세요';
                    break;
                case 'bold':
                    template = '**굵은 텍스트**';
                    break;
                case 'italic':
                    template = '*기울임 텍스트*';
                    break;
                case 'link':
                    const linkUrl = prompt('링크 URL을 입력하세요:', 'https://');
                    const linkText = prompt('링크 텍스트를 입력하세요:', '링크');
                    if (linkUrl && linkText) {
                        template = `[${linkText}](${linkUrl})`;
                    }
                    break;
                case 'code':
                    template = '`코드`';
                    break;
                case 'list':
                    template = '- 항목 1\n- 항목 2\n- 항목 3';
                    break;
                case 'step':
                    const stepNum = prompt('단계 번호를 입력하세요:', '1');
                    const stepTitle = prompt('단계 제목을 입력하세요:', '새 단계');
                    if (stepNum && stepTitle) {
                        template = `## ${stepNum}. ${stepTitle}\n\n단계 설명을 여기에 입력하세요.\n`;
                    }
                    break;
            }
            
            if (template) {
                codeMirrorEditor.replaceRange(template, cursor);
                addLog(`Markdown 템플릿 삽입: ${type}`);
            }
        }

        // 커서 위치에 이미지 직접 삽입
        function insertImageAtCursor() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.multiple = false;
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const cursor = codeMirrorEditor.getCursor();
                        let imageTag = '';
                        
                        if (currentWritingMode === 'basic') {
                            // 기본모드: 간단한 이미지 표시
                            imageTag = `![${file.name}](data:${file.type};base64,${btoa(e.target.result)})`;
                        } else {
                            // HTML모드: 완전한 HTML 태그
                            imageTag = `<img src="data:${file.type};base64,${btoa(e.target.result)}" alt="${file.name}" class="max-w-full h-auto rounded shadow-md my-4">`;
                        }
                        
                        codeMirrorEditor.replaceRange(imageTag, cursor);
                        addLog(`이미지 직접 삽입: ${file.name} (${currentWritingMode} 모드)`, 'success');
                    };
                    reader.readAsBinaryString(file);
                }
            };
            
            input.click();
        }
            const cursor = codeMirrorEditor.getCursor();
            let template = '';
            
            switch(type) {
                case 'heading':
                    template = '<h1>제목을 입력하세요</h1>';
                    break;
                case 'bold':
                    template = '<strong>굵은 텍스트</strong>';
                    break;
                case 'italic':
                    template = '<em>기울임 텍스트</em>';
                    break;
                case 'link':
                    const linkUrl = prompt('링크 URL을 입력하세요:', 'https://');
                    const linkText = prompt('링크 텍스트를 입력하세요:', '링크');
                    if (linkUrl && linkText) {
                        template = `<a href="${linkUrl}" target="_blank">${linkText}</a>`;
                    }
                    break;
                case 'image':
                    const imgSrc = prompt('이미지 경로를 입력하세요:', '/images/');
                    const imgAlt = prompt('이미지 설명을 입력하세요:', '이미지');
                    if (imgSrc && imgAlt) {
                        template = `<img src="${imgSrc}" alt="${imgAlt}" class="max-w-full h-auto rounded shadow-md my-4">`;
                    }
                    break;
                case 'code':
                    template = '<code>코드</code>';
                    break;
                case 'list':
                    template = '<ul>\n  <li>항목 1</li>\n  <li>항목 2</li>\n  <li>항목 3</li>\n</ul>';
                    break;
                case 'step':
                    const stepNum = prompt('단계 번호를 입력하세요:', '1');
                    const stepTitle = prompt('단계 제목을 입력하세요:', '새 단계');
                    if (stepNum && stepTitle) {
                        template = `
<div class="step-card bg-white p-6 rounded-lg shadow-md mb-6">
    <div class="flex items-center mb-4">
        <span class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-3">${stepNum}</span>
        <h3 class="text-xl font-semibold">${stepTitle}</h3>
    </div>
    <p class="text-gray-700 mb-4">단계 설명을 여기에 입력하세요.</p>
</div>`;
                    }
                    break;
            }
            
            if (template) {
                codeMirrorEditor.replaceRange(template, cursor);
                addLog(`템플릿 삽입: ${type}`);
            }
        }

        // HTML 템플릿 삽입
        function insertTemplate(type) {
            const cursor = codeMirrorEditor.getCursor();
            let template = '';
            
            switch(type) {
                case 'heading':
                    template = '<h1>제목을 입력하세요</h1>';
                    break;
                case 'bold':
                    template = '<strong>굵은 텍스트</strong>';
                    break;
                case 'italic':
                    template = '<em>기울임 텍스트</em>';
                    break;
                case 'link':
                    const linkUrl = prompt('링크 URL을 입력하세요:', 'https://');
                    const linkText = prompt('링크 텍스트를 입력하세요:', '링크');
                    if (linkUrl && linkText) {
                        template = `<a href="${linkUrl}" target="_blank">${linkText}</a>`;
                    }
                    break;
                case 'image':
                    const imgSrc = prompt('이미지 경로를 입력하세요:', '/images/');
                    const imgAlt = prompt('이미지 설명을 입력하세요:', '이미지');
                    if (imgSrc && imgAlt) {
                        template = `<img src="${imgSrc}" alt="${imgAlt}" class="max-w-full h-auto rounded shadow-md my-4">`;
                    }
                    break;
                case 'code':
                    template = '<code>코드</code>';
                    break;
                case 'list':
                    template = '<ul>\n  <li>항목 1</li>\n  <li>항목 2</li>\n  <li>항목 3</li>\n</ul>';
                    break;
                case 'step':
                    const stepNum = prompt('단계 번호를 입력하세요:', '1');
                    const stepTitle = prompt('단계 제목을 입력하세요:', '새 단계');
                    if (stepNum && stepTitle) {
                        template = `
<div class="step-card bg-white p-6 rounded-lg shadow-md mb-6">
    <div class="flex items-center mb-4">
        <span class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-3">${stepNum}</span>
        <h3 class="text-xl font-semibold">${stepTitle}</h3>
    </div>
    <p class="text-gray-700 mb-4">단계 설명을 여기에 입력하세요.</p>
</div>`;
                    }
                    break;
            }
            
            if (template) {
                codeMirrorEditor.replaceRange(template, cursor);
                addLog(`HTML 템플릿 삽입: ${type}`);
            }
        }

        // 실행취소/다시실행
        function undo() {
            codeMirrorEditor.undo();
        }

        function redo() {
            codeMirrorEditor.redo();
        }

        // 댓글 토글
        function toggleComment() {
            const selection = codeMirrorEditor.getSelection();
            if (selection) {
                if (selection.startsWith('<!-- ') && selection.endsWith(' -->')) {
                    codeMirrorEditor.replaceSelection(selection.slice(5, -4));
                } else {
                    codeMirrorEditor.replaceSelection(`<!-- ${selection} -->`);
                }
            }
        }

        // 로컬 저장
        function saveToLocal() {
            const content = codeMirrorEditor.getValue();
            const fileName = currentFile || 'untitled.html';
            localStorage.setItem(`admin_${fileName}`, content);
            addLog(`로컬 저장: ${fileName}`, 'success');
            alert('로컬 스토리지에 저장되었습니다!');
        }

        // 로컬에서 불러오기
        function loadFromLocal() {
            const fileName = currentFile || 'untitled.html';
            const content = localStorage.getItem(`admin_${fileName}`);
            if (content) {
                codeMirrorEditor.setValue(content);
                updatePreview();
                addLog(`로컬에서 불러오기: ${fileName}`, 'success');
            } else {
                alert('저장된 파일이 없습니다.');
            }
        }

        // 파일 내보내기
        function exportFile() {
            const content = codeMirrorEditor.getValue();
            const fileName = currentFile || 'export.html';
            const blob = new Blob([content], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            addLog(`파일 내보내기: ${fileName}`, 'success');
        }

        // 파일 가져오기
        function importFile() {
            document.getElementById('import-file').click();
        }

        // 파일 가져오기 처리
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    codeMirrorEditor.setValue(e.target.result);
                    updatePreview();
                    addLog(`파일 가져오기: ${file.name}`, 'success');
                };
                reader.readAsText(file);
            }
        }

        // 미리보기 모드 토글
        function togglePreviewMode() {
            isPreviewMode = isPreviewMode === 'html' ? 'markdown' : 'html';
            document.getElementById('previewModeBtn').textContent = isPreviewMode.toUpperCase();
            updatePreview();
            addLog(`미리보기 모드: ${isPreviewMode}`);
        }

        // 로그아웃
        function logout() {
            sessionStorage.removeItem('adminAuth');
            sessionStorage.removeItem('adminUser');
            window.location.href = '/admin.html';
        }

        // 파일 로드
        async function loadFile(filename) {
            try {
                let filePath = filename;
                if (filename !== 'index.html') {
                    filePath = `/guides/${filename}`;
                }
                
                const response = await fetch(filePath);
                if (response.ok) {
                    fileContent = await response.text();
                    codeMirrorEditor.setValue(fileContent);
                    document.getElementById('current-file').innerHTML = `
                        <div class="flex items-center">
                            <span class="text-green-600 mr-2">📄</span>
                            <span class="font-medium">${filename}</span>
                            <span class="ml-2 px-2 py-1 bg-green-100 text-green-800 text-xs rounded">로드됨</span>
                        </div>
                    `;
                    currentFile = filename;
                    updatePreview();
                    addLog(`파일 로드: ${filename}`, 'success');
                } else {
                    alert('파일을 불러올 수 없습니다.');
                    addLog(`파일 로드 실패: ${filename}`, 'error');
                }
            } catch (error) {
                console.error('파일 로드 오류:', error);
                alert('파일 로드 중 오류가 발생했습니다.');
                addLog(`파일 로드 오류: ${filename}`, 'error');
            }
        }

        // 미리보기 업데이트
        function updatePreview() {
            const content = codeMirrorEditor.getValue();
            const preview = document.getElementById('preview');
            
            // 글쓰기 모드에 따른 미리보기
            if (currentWritingMode === 'markdown' || isPreviewMode === 'markdown') {
                preview.innerHTML = marked.parse(content);
            } else {
                if (content.includes('<!DOCTYPE') || content.includes('<html')) {
                    const iframe = document.createElement('iframe');
                    iframe.style.width = '100%';
                    iframe.style.height = '100%';
                    iframe.style.border = 'none';
                    preview.innerHTML = '';
                    preview.appendChild(iframe);
                    iframe.contentDocument.write(content);
                    iframe.contentDocument.close();
                } else {
                    preview.innerHTML = content;
                }
            }
        }

        // 이미지 업로드
        function handleImageUpload(event) {
            const files = Array.from(event.target.files);
            const previewContainer = document.getElementById('image-preview');
            previewContainer.innerHTML = '';
            
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageDiv = document.createElement('div');
                    imageDiv.className = 'p-2 border rounded bg-gray-50';
                    imageDiv.innerHTML = `
                        <img src="${e.target.result}" class="w-full h-20 object-cover rounded mb-2">
                        <p class="text-xs text-gray-600 mb-1">${file.name}</p>
                        <button onclick="insertImageTag('${file.name}')" 
                                class="w-full px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">
                            편집기에 삽입
                        </button>
                    `;
                    previewContainer.appendChild(imageDiv);
                };
                reader.readAsDataURL(file);
            });
            
            addLog(`이미지 업로드: ${files.length}개 파일`);
        }

        // 이미지 태그 삽입
        function insertImageTag(filename) {
            const cursor = codeMirrorEditor.getCursor();
            const imageTag = `<img src="/images/${filename}" alt="${filename}" class="max-w-full h-auto rounded shadow-md my-4">`;
            codeMirrorEditor.replaceRange(imageTag, cursor);
            addLog(`이미지 태그 삽입: ${filename}`);
        }

        // 단계 추가 (기존 함수)
        function addStep() {
            insertTemplate('step');
        }

        // 이미지 추가 버튼
        function addImage() {
            document.getElementById('image-upload').click();
        }

        // 파일 저장
        function saveFile() {
            if (!currentFile) {
                alert('먼저 파일을 선택해주세요.');
                return;
            }
            
            const content = codeMirrorEditor.getValue();
            localStorage.setItem(`edited_${currentFile}`, content);
            
            addLog(`파일 저장: ${currentFile}`, 'success');
            alert('파일이 저장되었습니다! (로컬 스토리지에 임시 저장됨)');
        }

        // 배포
        function deployChanges() {
            if (!currentFile) {
                alert('먼저 파일을 편집해주세요.');
                return;
            }
            
            if (confirm('변경사항을 Git에 커밋하고 배포하시겠습니까?')) {
                addLog('배포 시작...', 'info');
                setTimeout(() => {
                    addLog('배포 완료!', 'success');
                    alert('배포가 완료되었습니다!');
                }, 2000);
            }
        }

        // 사이트 보기
        function viewSite() {
            window.open('/', '_blank');
        }

        // 로그 추가
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('activity-log');
            const timestamp = new Date().toLocaleString('ko-KR');
            const colors = {
                'info': 'text-blue-600',
                'success': 'text-green-600',
                'error': 'text-red-600'
            };
            
            const logEntry = document.createElement('p');
            logEntry.className = `text-sm ${colors[type] || 'text-gray-600'} mb-1`;
            logEntry.innerHTML = `${message} - <span class="text-gray-500">${timestamp}</span>`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
    </script>
</body>
</html>