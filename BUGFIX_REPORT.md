# 페르소나 생성 오류 해결 보고서

## 문제 상황
사용자가 보고한 문제:
- 페르소나 생성 시 자주 오류 발생 (성공률: 10번 중 1번)
- 이전에 성공했던 대본도 실패
- API 키를 변경해도 동일한 문제 지속
- 오류 메시지: "All character generation failed. Please try with different content or check your internet connection."

## 원인 분석
1. **Rate Limit 문제**: Google Gemini API의 rate limit에 자주 도달
2. **재시도 로직 부족**: 일시적인 API 오류 발생 시 즉시 실패
3. **불충분한 대기 시간**: 연속 요청 사이 2초 지연으로 부족
4. **에러 메시지 불명확**: 사용자가 문제 해결 방법을 알 수 없음
5. **진행 상황 표시 부족**: 사용자가 현재 상태를 알 수 없음

## 해결 방안

### 1. Exponential Backoff 재시도 로직 구현
```typescript
const retryWithBackoff = async <T>(
  fn: () => Promise<T>,
  maxRetries: number = 3,
  baseDelay: number = 2000
): Promise<T>
```
- 최대 3번까지 재시도
- 재시도 시마다 대기 시간 2배 증가 (2초 → 4초 → 8초)
- Rate limit, Quota exceeded, Unavailable 등의 에러에만 재시도 적용

### 2. API 호출 지연 시간 증가
- **이전**: 요청 간 2초 대기
- **변경**: 요청 간 3-4초 랜덤 대기
- 랜덤 지연으로 burst traffic 방지

### 3. 에러 메시지 개선
상세한 에러 메시지와 해결 방법 제공:

#### Rate Limit 에러
```
❌ 너무 많은 요청을 보냈습니다.

해결 방법:
1. 5분 정도 기다린 후 다시 시도해주세요.
2. 캐릭터 수를 줄여서 시도해보세요.
3. 한 번에 하나씩 생성해보세요.
```

#### Quota Exceeded 에러
```
❌ API 사용량 한도가 초과되었습니다.

해결 방법:
1. 5-10분 후 다시 시도해주세요.
2. Google Cloud Console에서 할당량을 확인해주세요.
3. 필요시 요금제를 업그레이드해주세요.
```

### 4. 실시간 진행 상황 표시
- 각 단계별 진행 상황 표시:
  - "API 키 확인 중..."
  - "대본 분석 중..."
  - "3개 캐릭터 이미지 생성 준비 중..."
  - "캐릭터 1/3 생성 중: 김민준"
  - "다음 캐릭터 생성 전 대기 중... (3초)"

### 5. 부분 성공 처리 개선
- 일부 캐릭터만 실패해도 성공한 캐릭터는 반환
- 실패한 캐릭터 정보를 로그에 명시
- Fallback 프롬프트로 재시도

## 변경된 파일

### `services/geminiService.ts`
1. `retryWithBackoff()` 함수 추가
2. 모든 API 호출에 재시도 로직 적용
3. 캐릭터 생성 간 대기 시간 증가 (2초 → 3-4초)
4. 영상 소스 생성 간 대기 시간 증가 (3초 → 3-4초)
5. 진행 상황 콜백 파라미터 추가 (`onProgress`)
6. 상세한 에러 메시지 추가

### `App.tsx`
1. `loadingProgress` state 추가
2. `generateCharacters()`에 진행 상황 콜백 전달
3. `generateStoryboard()`에 진행 상황 콜백 전달
4. 로딩 UI에 실시간 진행 상황 표시
5. API 대기 시간 안내 메시지 추가

## 기대 효과

### 성공률 향상
- **이전**: 10번 중 1번 성공 (10%)
- **예상**: 10번 중 8-9번 성공 (80-90%)

### 개선 사항
1. ✅ Rate limit 도달 시 자동으로 대기 후 재시도
2. ✅ 일시적인 API 오류에서 자동 복구
3. ✅ 사용자에게 명확한 진행 상황 제공
4. ✅ 실패 시 구체적인 해결 방법 안내
5. ✅ 일부 캐릭터 실패 시에도 나머지는 사용 가능

## 사용자 권장 사항

### API 사용량이 많은 경우
1. 한 번에 생성하는 캐릭터/이미지 수를 줄이기 (3-5개 권장)
2. 각 생성 사이에 1-2분 간격 두기
3. Google Cloud Console에서 할당량 확인

### 오류가 계속되는 경우
1. 5-10분 대기 후 재시도
2. 캐릭터 수를 1-2개로 줄여서 테스트
3. API 키 할당량 확인
4. 다른 API 키로 시도

## 추가 모니터링
- 콘솔에서 재시도 로그 확인 가능
- 각 재시도 시도와 대기 시간 표시
- 실패한 요청의 상세 정보 로깅

## 배포 후 확인 사항
- [ ] 페르소나 생성 성공률 모니터링
- [ ] Rate limit 도달 빈도 확인
- [ ] 사용자 피드백 수집
- [ ] 평균 생성 시간 측정

---

**수정일**: 2025년 10월 19일  
**담당자**: GitHub Copilot  
**버전**: 1.0
